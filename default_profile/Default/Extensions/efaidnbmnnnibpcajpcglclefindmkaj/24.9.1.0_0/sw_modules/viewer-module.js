/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{analytics as e}from"../common/analytics.js";import{communicate as t}from"./communicate.js";import{util as n}from"./util.js";import{SETTINGS as r}from"./settings.js";import{dcLocalStorage as o}from"../common/local-storage.js";import{downloadManager as s}from"./download-manager.js";import{privateApi as i}from"./private-api.js";import{viewerModuleUtils as a}from"./viewer-module-utils.js";import{floodgate as c}from"./floodgate.js";import{openLocalFteWindow as u}from"./ch-context-menu.js";import{OFFSCREEN_DOCUMENT_PATH as l}from"../common/constant.js";import{common as m}from"./common.js";import{offscreenActions as f}from"./offscreen-actions.js";import{CACHE_PURGE_SCHEME as p}from"./constant.js";let d=null,E=!1,_=chrome.runtime.getURL("viewer.html"),h=!1,I={};chrome.extension.isAllowedFileSchemeAccess((e=>{h=e}));const g=e=>{chrome.tabs.get(e.tabId,(e=>{chrome.runtime.lastError||v(e)}))};function v(e){if(!r.IS_READER&&0!=t.version&&(1!=t.version||0!=t.NMHConnStatus)&&e.url){const t=new URL(e.url);chrome.runtime.id===t.host?(chrome.contextMenus.update("convertPageContextMenu",{visible:!1}),chrome.contextMenus.update("appendPageContextMenu",{visible:!1})):(chrome.contextMenus.update("convertPageContextMenu",{visible:!0}),chrome.contextMenus.update("appendPageContextMenu",{visible:!0}))}}function L(e){const t=new Date;t.setMinutes(t.getMinutes()+r.VIEWER_RECHECK_CDN_ACCESS_DELAY_MINS),o.setItem("netAccAdT",t.getTime()),o.setItem("netAcc",e)}const R=e=>{if(!e||null===e||"undefined"===e)return!1;let t=[/^chrome\:\/\//,/^chrome\-extension\:\/\//,/^https:\/\/([a-zA-Z\d-]+\.){0,}officeapps.live.com/,/^https\:\/\/*.*\/(saml|login)/,/^https:\/\/sharedcloud.([a-zA-Z\d-]+)+.(s3|s3-accelerate).amazonaws.com/,/^https\:\/\/*.*.\/(login|auth|okta|saml).*\/S*|\/(login|auth|okta|saml|IWA|owa)\//,/^https\:\/\/www.google.com\/search\?q/,/^https\:\/\/www.citibank.*/,/^https:\/\/[^/]*\.*\/([$-/:-?{-~!"^_`\[\]A-Za-z0-9]*)view-sdk/];let n=c.getFeatureMeta("dc-cv-invalid-urls");if(n){n=JSON.parse(n);for(let e in n)n[e]=new RegExp(n[e]);t=n}return!![/^http\:\/\/[^/]/,/^https\:\/\/[^/]/,/^file?:/].find((t=>t.test(e)))&&!t.find((t=>t.test(e)))};function w(){try{return"true"===o.getItem("pdfViewer")}catch(e){return!1}}function C(e,t){for(let n=0;n<e.length;++n){let r=e[n];if(r.name.toLowerCase()===t)return r}}function D(t){if(void 0!==t.responseHeaders){const n=C(t.responseHeaders,"content-type"),r=C(t.responseHeaders,"content-disposition");if(n){const o=n.value.toLowerCase().split(";",1)[0].trim();if(r&&/^\s*attachment[;]?/i.test(r.value))return!1;if("application/pdf"===o)return!0;if("application/octet-stream"===o){if(r&&/\.pdf(["']|$)/i.test(r.value))return e.event(e.e.VIEWER_PDF_PROCESS_OS_CD),!0;t.url.toLowerCase().indexOf(".pdf")>0&&e.event(e.e.VIEWER_PDF_PROCESS_OS_URL)}}}else if("file"==function(e){let t=e.indexOf("/");return e.substr(0,t-1)}(t.url)&&"PDF"==function(e){if(e)try{let t=new URL(e).pathname;return t.substr(t.lastIndexOf(".")+1).toUpperCase()}catch(e){return""}return""}(t.url))return!0;return!1}const A=async(r,o,i)=>{const a=i.incognito;if("complete"===i.status&&v(i),"loading"===o.status){t.loading({id:r});try{!n.isViewerURL(i.url)||w()&&!a||b(r,function(e,t){t||(t=window.location.href);try{const n=new URL(t);return new URLSearchParams(n.search).get(e)}catch(e){return}}("pdfurl",i.url))}catch(e){}}else if("complete"===o.status){s.newTab(i.url,r);const t=await chrome.extension.isAllowedFileSchemeAccess();i.url.toLowerCase().startsWith("file://")&&i.url.toLowerCase().endsWith(".pdf")&&!t&&(u(i),e.event(e.e.LOCAL_FILE_OPENED))}};function b(e,t){e&&t&&chrome.tabs.update(e,{url:t})}function O(e){try{const t=new URL(e.url),n=new URLSearchParams(t.search);let r=!1;const o=e.initiator;return o&&["https://classroom.google.com","https://mail.google.com","https://drive.google.com"].includes(o)&&n.forEach(((e,t)=>{t.startsWith("print")&&"true"===e&&(r=!0)})),r}catch(e){return!1}}async function P(t){try{if(o.getItem("retryOnNextPage")){await chrome.scripting.executeScript({target:{tabId:t},files:["content_scripts/injectCopyLSIframe.js"]}),await n.sleep(300),e.event(e.e.LOCAL_STORAGE_MIGRATION_RETRYING);const r=await chrome.runtime.sendMessage({main_op:"copy-ls"});chrome.tabs.sendMessage(t,{content_op:"remove-lsCopy"}).catch((()=>null)),"succeed"===r&&(e.event(e.e.LOCAL_STORAGE_MIGRATION_RETRYING_SUCCESS),o.removeItem("retryOnNextPage"),Object.assign(o.storage,await chrome.storage.local.get()))}}catch(e){}}const T=(F=chrome.runtime.getURL(""),F?.replace(/\/+$/,""));var F;function N(t){t.initiator!==T&&"main_frame"!==t.type&&function(t){if(void 0!==t.responseHeaders){const n=C(t.responseHeaders,"content-type"),r=C(t.responseHeaders,"content-disposition");if(n){const o=n.value.toLowerCase().split(";",1)[0].trim();if("application/pdf"===o)return e.event(e.e.VIEWER_PDF_DETECT_EMBED_PDF_TYPE_PDF),!0;if("application/octet-stream"===o){if(r&&/\.pdf(["']|$)/i.test(r.value))return e.event(e.e.VIEWER_PDF_DETECT_EMBED_PDF_OCTET_CD),!0;if(new URL(t.url).pathname.toLowerCase().endsWith(".pdf"))return e.event(e.e.VIEWER_PDF_DETECT_EMBED_PDF_OCTET_URL),!0}}}return!1}(t)&&e.event(e.e.VIEWER_PDF_DETECT_EMBED_PDF)}function S(t){i.isMimeHandlerAvailable().then((async s=>{const{tabId:i}=t;if(await P(i),o.getItem("sessionStarted")||(o.setItem("sessionId",n.uuid()),o.setItem("sessionStarted",!0)),!s){let o=n.parseExtensionURL(t.url);if(o){o=_+"?pdfurl="+o+"&tabId="+i;let n=t.url.indexOf("#");n>0&&(o+=t.url.slice(n)),r.VIEWER_ENABLED&&w()&&!E&&e.event(e.e.VIEWER_EXTN_PDF_OPENED,{tabURL:o}),f.setupWorkerOffscreen(),chrome.tabs.update(i,{url:o})}}}))}function y(t){try{c.hasFlag("dc-cv-enable-webpage-domain-tracking",p.NO_CALL).then((n=>{if(n&&"main_frame"===t.type){const n=new URL(t.url).hostname;e.event(e.e.VIEWER_PDF_WEBPAGE_OPENED,{domain:n})}}))}catch(e){}}function V(s,c){i.isMimeHandlerAvailable().then((async i=>{o.getItem("sessionStarted")||(o.setItem("sessionId",n.uuid()),o.setItem("sessionStarted",!0));const{tabId:u}=s;if(i){const e=O(s),t=s.tabId;t>-1&&(I[t]={isGooglePrint:e})}else{if("main_frame"===s.type){if(await P(u),!function(){if(!navigator.onLine&&o.getItem("offlineSupportDisable"))return!1;const e=new Date,t=o.getItem("netAcc"),n=o.getItem("netAccAdT");return!(n&&n>e.getTime())||t}()||!function(t){if("GET"!==t.method||!r.VIEWER_ENABLED||!w())return!1;let n=t.url,s=`reloadurl-${t.tabId}`;const i=o.getItem(s);if(i&&i===n){try{o.removeItem(s)}catch(e){}return!1}if(!R(n))return!1;const a=D(t);return E?(a&&e.event(e.e.VIEWER_FALLBACK_TO_NATIVE_INCOGNITO),!1):a}(s))return;if(c&&!h)return void e.event(e.e.VIEWER_PDF_LOCAL_FILE_IGNORED);d=s.url,c&&e.event(e.e.VIEWER_PDF_LOCAL_FILE),a.updateVariables(t.version),a.fetchAndUpdateVersionConfig();let n=function(e){let t=_;if(t+="?pdfurl="+encodeURIComponent(e.url),t+="&tabId="+e.tabId,void 0!==e.responseHeaders){const n=C(e.responseHeaders,"content-length");n&&(t+="&clen="+n.value);const r=C(e.responseHeaders,"accept-ranges");r&&r.value&&"bytes"===r.value.toLowerCase()&&(t+="&chunk=true");const o=C(e.responseHeaders,"content-disposition");if(o&&o.value&&/\.pdf(["']|$)/i.test(o.value)){const e=/filename[^;=\n\*]?=((['"]).*?\2|[^;\n]*)/.exec(o.value);null!=e&&e.length>1&&(t+="&pdffilename="+e[1].replace(/['"]/g,""))}}return O(e)&&(t+="&googlePrint=true"),t}(s);e.event(e.e.VIEWER_EXTN_PDF_OPENED,{tabURL:d}),f.setupWorkerOffscreen();for(let e=0;e<20;e++)try{await chrome.tabs.update(u,{url:n})}catch(e){}}"sub_frame"===s.type&&function(e){return/^https:\/\/[^/]*(acrobat|adobe)\.com\/proxy\/chrome-viewer/.test(e)}(s.url)&&(200!==s.statusCode?403===s.statusCode?(o.setItem("pdfViewer","false"),e.event(e.e.VIEWER_FALLBACK_TO_NATIVE_CDN_FORBIDDEN,{tabURL:s.url}),b(s.tabId,d)):(L(!1),e.event(e.e.VIEWER_FALLBACK_TO_NATIVE_CDN_OFFLINE,{tabURL:s.url}),b(s.tabId,d)):L(!0))}}))}t.registerHandlers({"check-is-google-print":function(e,t,n){return I&&I[e.tabId]?n({isGooglePrint:I[e.tabId].isGooglePrint}):n({isGooglePrint:!1})}});export{V as processRequest,S as honorRequest,g as onTabActivated,A as onTabsUpdated,N as detectEmbeddedPDF,y as logWebpageDomain};