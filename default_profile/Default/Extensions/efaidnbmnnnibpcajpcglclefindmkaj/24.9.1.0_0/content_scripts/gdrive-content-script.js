/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
(()=>{const e="-shared",t="acrobatDisconnectContentScriptStart",n="application/pdf",o="data-double-click-handler-added",r="acrobat-prompt";let i,a,s,c,d,l,u,m,p=!1,h=new AbortController;const w=()=>window.location.href.includes("/file"),g=e=>{try{chrome.runtime.sendMessage({main_op:"analytics",analytics:e})}catch(e){}},b=async()=>{if(a)return Promise.resolve(a);P();const e=G();if(a=await e,a)return Promise.resolve(a);const t=(()=>{for(let e=0;e<i?.selectors?.loggedInUserExtendedName.length;e++){const{element:t,attribute:{name:n}}=i?.selectors?.loggedInUserExtendedName[e],o=document.querySelector(t);if(o){const e=o.getAttribute(n);if(e)return e}}return null})();if(!t)return Promise.resolve("");for(let e=0;e<i?.selectors?.assetOwnerIdName.length;e++){const{element:n,attribute:{id:o,name:r}}=i?.selectors?.assetOwnerIdName[e],s=document.querySelectorAll(n);if(s&&s.length>0)for(let e=0;e<s.length;e++){const n=s[e].getAttribute(r);if(t?.includes(n)){const t=s[e].getAttribute(o);if(t)return a=t,a}}}return Promise.resolve(a)},f=()=>{setTimeout((()=>{try{const e=C();e&&v(e)}catch(e){}}),1e3)},v=e=>{try{const t=I(e);t&&t?.mimeType===n&&g([["DCBrowserExt:Gdrive:PDF:Viewer"]])}catch(e){}},y=e=>{try{e.addEventListener("dblclick",f,{signal:h.signal})}catch(e){}},E=e=>{try{for(let t of e){const e=t.closest("[role='row']");t.getAttribute(o)||(t.setAttribute(o,"true"),y(e))}}catch(e){}},A=t=>{if(p||t){const t=document.getElementsByClassName(r);t&&t.length>0&&t[0].parentElement.removeChild(t[0]);const n=document.getElementsByClassName(r+e);n&&n.length>0&&n[0].parentElement.removeChild(n[0]);const o=document.getElementById("acrobat-prompt");o?.parentElement.removeChild(o),p=!1}},C=()=>((e,t)=>{if(e){const n=i?.selectors,o=n&&n[t];for(let t=0;t<o?.length;t++){let n=e.querySelector(o[t]);if(n)return n}}return null})(document,"fileDetails"),I=e=>{try{return JSON.parse(e?.textContent?.replace(/\\/g,""))}catch(e){return null}},x=t=>{const n=document.createElement("div"),o=(()=>{const e=document.createElement("img");e.setAttribute("src",chrome.runtime.getURL("browser/images/acrobat_dc_appicon_128.png"));const t=w()?"acrobat-icon-shared":"acrobat-icon";return e.setAttribute("class",t),e})(),a=(()=>{const e=document.createElement("span"),t=w()?"acrobat-prompt-text-shared":"acrobat-prompt-text";return e.setAttribute("class",t),e.textContent=i?.acrobatPromptText||"Edit with Acrobat",e})(),s=(()=>{const e=document.createElement("div"),t=w()?"acrobat-prompt-tooltip":"acrobat-prompt-tooltip-shared";return e.setAttribute("class",t),e.textContent=i?.acrobatPromptText||"Edit with Acrobat",e})(),c=w()?r+e:r;return n.setAttribute("class",c),n.appendChild(o),n.appendChild(s),n.appendChild(a),n.addEventListener("click",(()=>(async e=>{g([[`DCBrowserExt:Gdrive_EditWithAcrobat:Clicked: ${e}`]]);const t=C(),n=I(t),o=await b(),r=JSON.stringify({ids:[n.id],action:"open",userId:o,resourceKeys:{}}),a=e?`&installStatus=${e}`:"",s=`${i.addOnHost}?state=${r}&origin=browser_extension${a}`;window.open(s,"_blank")})(t)),{signal:h.signal}),n},S=async(e,t)=>{try{let o=I(e);if(!o)return g([["DCBrowserExt:Gdrive:FileId:NotFound"]]),void A();if(o?.mimeType!==n)return void A();if(!await b())return g([["DCBrowserExt:Gdrive:UserId:NotFound"]]),void A();if(p)return;const r=x(t),a=(()=>{let e;for(let t=0;t<i?.selectors?.promptParentElement.length&&(e=document.querySelector(i?.selectors?.promptParentElement[t]),!e);t++);return e})();a&&a?.childNodes?.length>0?(a.insertBefore(r,a.childNodes[0]),p=!0,window.innerWidth>1080&&g([[`DCBrowserExt:Gdrive_EditWithAcrobat:Shown:${t}`]])):A()}catch(e){A()}},_=()=>{const e=C();if(e){I(e).mimeType===n?i?.enableFramingToGetAddOnInstallStatus&&chrome.runtime?.id?(e=>{try{if(s)return;let t=I(e);if(!t)return D(),A(),void g([["DCBrowserExt:Gdrive:FileId:NotFound"]]);if(t?.mimeType!==n)return D(),void A();if(!t||t?.mimeType!==n)return;const o=document.createElement("iframe"),r=window?.document?.location?.pathname.includes("/u/")?window.document.location.pathname.split("/")[3]:0;o.setAttribute("src",`https://workspace.google.com/u/${r}/marketplace/appfinder/app/${i?.addOnId}?tabId=${i?.tabId}&contentScriptIframe=true&origin=https%3A%2F%2Fdrive.google.com&extension_type=drive_app&pann=drive_app_widget&app_capability=1&hl=en&pre_installed_app_ids=${i?.addOnId}`),o.setAttribute("id","acrobat-addon-installation-page"),o.style.cssText="position:absolute; top:100px; height:500px; width:800px; visibility: hidden",document.body.append(o),s=!0,l=new Promise((e=>{d=e})),l?.then((({fileDetailsElement:e,installStatus:t})=>S(e,t)))}catch(e){}})(e):S(e):(D(),A())}else A(),D()},N=e=>{let t=!1;if(e)for(let n of e)if(n.addedNodes){t=!0;break}if(t||!e){const e=document.querySelectorAll('.O5x1db.ACGwFc:not([data-double-click-handler-added="true"])');e&&E(e);const t=document.querySelectorAll(".jGNTYb.ACGwFc:not([data-double-click-handler-added='true'])");t&&E(t)}},D=e=>{if(s||e){const e=document.getElementById("acrobat-addon-installation-page");e&&e.parentElement?.removeChild(e),s=!1,l=null,d=null}},F=e=>{if("add-on-install-status"===e.content_op){const t=C();t?d({fileDetailsElement:t,installStatus:e.installStatus}):(D(),A())}},P=()=>{document.addEventListener("userId",(e=>{const t=e?.detail?.userId;u(t),e?.detail?.userId||g([["DCBrowserExt:Gdrive:UserId:NotInMainWindow"]])}),{signal:h.signal})},G=()=>{let e=document.createElement("script");return e.src=chrome.runtime.getURL("browser/js/gdrive-inject.js"),e.onload=function(){this.remove()},(document.head||document.documentElement).appendChild(e),new Promise((e=>{u=e}))};const k=()=>{if(A(!0),D(!0),document?.body?.querySelector(`[${o}]`)){const e=document.querySelectorAll(`[${o}]`);for(let t=0;t<e.length;t++)e[t].removeAttribute(o)}},O=()=>{chrome.runtime?.id||(m&&m.disconnect(),A(),D(),h.abort(),chrome.runtime.onMessage.removeListener(F))},U=()=>{window.dispatchEvent(new Event("orphanContentScript")),window.dispatchEvent(new Event(t)),chrome.runtime.onMessage.addListener(F),window.addEventListener(t,O,{signal:h.signal}),chrome.runtime.sendMessage({main_op:"gdrive-init"},(e=>{(e.enableAcrobatPromptInGSuite||window.location?.search?.includes("enableAcrobatPromptInGSuite"))&&(g([["DCBrowserExt:Gdrive:PromotionFeature:Enable"]]),i=e,c=chrome.runtime.getURL("browser/images/acrobat_dc_appicon_128.png"),function(){const e=chrome.runtime.getURL("browser/css/fonts/AdobeClean-Regular.otf"),t=new FontFace("AdobeClean-Regular",`url(${e})`);t.load().then((()=>{document.fonts.add(t)}))}(),k(),_(),N(),(()=>{try{const e={childList:!0,subtree:!0,attributes:!0,attributeFilter:["style"]};m=new MutationObserver((function(e){m.takeRecords(),N(e),_()})),m.observe(document.body,e)}catch(e){}})())}))};chrome.runtime.onMessage.addListener((function(e,t,n){"acrobatGsuiteTouchPointsDisabled"===e.content_op&&(m?.disconnect(),k())})),chrome.storage.local.get("acrobat-gsuite-touch-points",(function(e){"false"!==e["acrobat-gsuite-touch-points"]&&("workspace.google.com"===window?.document?.location?.host&&window?.document?.location?.ancestorOrigins.length>0&&"https://drive.google.com"===window?.document?.location?.ancestorOrigins[0]&&(window.document.location.pathname.includes("359458075047")||window.document.location.pathname.includes("80763634447")||window.document.location.pathname.includes("391079731570"))?(()=>{let e=new URLSearchParams(window.document.location.search);if(e.get("contentScriptIframe")){const t=document.querySelectorAll("#yDmH0d > c-wiz > div > c-wiz > div > c-wiz > div > div.YKOwYb > div > div > div.pANFDd > div > button:not([style*= 'display: none']) > span");let n;if(t.length>0)if(t?.length>1){n="Uninstalled";for(let e of t)if("Uninstall"===e?.textContent?.trim()){n="Installed";break}}else n="Uninstall"===t[0]?.textContent?.trim()?"Installed":"Uninstalled";else n="Unknown";chrome.runtime.sendMessage({main_op:"add-on-install-status",tabId:e.get("tabId"),installStatus:n})}})():"drive.google.com"===window?.document?.location?.host&&window.top===window.self&&0===window?.document?.location?.ancestorOrigins.length&&U())}))})();