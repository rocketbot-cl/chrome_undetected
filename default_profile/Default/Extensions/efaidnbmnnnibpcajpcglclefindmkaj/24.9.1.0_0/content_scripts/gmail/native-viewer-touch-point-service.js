/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{getElementBasedOnSelector,getFileDetailsElementInNativeViewer,createAcrobatIconElement,sendAnalytics,createURLForAttachment,isOrphanContentScript}from"./util.js";import state from"./state.js";const NATIVE_VIEWER_PROMPT_CLASS="acrobat-native-viewer-prompt",hideNativeViewerPrompt=e=>{if(!state.nativeViewerPromptState?.nativeViewerPromptVisible&&!e)return;const t=document.getElementsByClassName(NATIVE_VIEWER_PROMPT_CLASS);t&&t[0]&&t[0].parentElement.removeChild(t[0]),state.nativeViewerPromptState.nativeViewerPromptVisible=!1},createNativeViewPromptTextElement=()=>{const e=document.createElement("span");return e.setAttribute("class","acrobat-native-viewer-prompt-text"),e.textContent=state?.gmailConfig?.acrobatPromptText||"Open with Acrobat",e},getParentElementForNativeViewerPrompt=()=>getElementBasedOnSelector(document,"nativeViewerPromptParentElement","nativeViewer"),getAnalyticsType=e=>"LIST_VIEW"===e?"NativeViewerPromptLV":"NativeViewerPrompt",createNativeViewerPrompt=(e,t,i)=>{const r=document.createElement("a"),a=createAcrobatIconElement(),n=createNativeViewPromptTextElement(),o=createURLForAttachment(e,"GmailNativeViewer",t);return r.setAttribute("class",NATIVE_VIEWER_PROMPT_CLASS),r.setAttribute("href",o),r.setAttribute("target","_blank"),r.appendChild(a),r.appendChild(n),r.addEventListener("click",(()=>{const e=getAnalyticsType(i);sendAnalytics([[`DCBrowserExt:Gmail:${e}:Clicked`]])})),r},processForAlreadyShownNativeViewerPrompt=()=>{const{nativeViewerPromptVisible:e,previousFileDetailsElement:t,nativeViewerAttachmentURL:i}=state?.nativeViewerPromptState;if(e){const e=getFileDetailsElementInNativeViewer();e?e!==t&&hideNativeViewerPrompt():(state.nativeViewerPromptState.previousFileDetailsElement=null,state.nativeViewerPromptState.nativeViewerAttachmentURL=null,hideNativeViewerPrompt())}else if(t&&!isOrphanContentScript()){const e=getFileDetailsElementInNativeViewer();e&&t===e&&addAcrobatPromptInNativeViewer(i)}},addAcrobatPromptInNativeViewer=(e,t,i)=>{try{const{nativeViewerPromptVisible:r}=state?.nativeViewerPromptState;if(r)return;const a=createNativeViewerPrompt(e,t,i),n=getParentElementForNativeViewerPrompt();if(n&&n?.childNodes?.length>0){if(n.insertBefore(a,n.childNodes[0]),state.nativeViewerPromptState.nativeViewerPromptVisible=!0,state.nativeViewerPromptState.nativeViewerAttachmentURL=e,state.nativeViewerPromptState.previousFileDetailsElement=getFileDetailsElementInNativeViewer(),window.innerWidth>1200){const e=getAnalyticsType(i);sendAnalytics([[`DCBrowserExt:Gmail:${e}:Shown`]])}}else hideNativeViewerPrompt()}catch(e){hideNativeViewerPrompt()}},getFileDetails=e=>{try{return JSON.parse(e?.textContent?.replace(/\\/g,""))}catch(e){return null}},processForNativeViewer=(e,t)=>{const i=getFileDetailsElementInNativeViewer();if(i&&!isOrphanContentScript()){const r=getFileDetails(i);if(e?.name&&r&&e?.name!==r.title)return;addAcrobatPromptInNativeViewer(e?.url,r.title,t)}else hideNativeViewerPrompt()},sendAnalyticsIfNativeViewerLaunched=e=>{getFileDetailsElementInNativeViewer()&&sendAnalytics([[`DCBrowserExt:Gmail:NativeViewerLV:${e}`]])},removeAllTouchPoints=()=>{hideNativeViewerPrompt(!0)};export{processForAlreadyShownNativeViewerPrompt,sendAnalyticsIfNativeViewerLaunched,processForNativeViewer,removeAllTouchPoints};